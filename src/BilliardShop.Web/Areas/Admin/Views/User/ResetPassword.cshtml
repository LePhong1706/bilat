@model ResetPasswordViewModel
@{
    ViewData["Title"] = "Reset mật khẩu";
}

<div class="page-header-breadcrumb mb-3">
    <div class="d-flex align-items-center justify-content-between">
        <h1 class="page-title fw-medium fs-18 mb-0">Reset mật khẩu</h1>
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">Admin</a></li>
            <li class="breadcrumb-item"><a asp-action="Index">Người dùng</a></li>
            <li class="breadcrumb-item active" aria-current="page">Reset mật khẩu</li>
        </ol>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-xl-6">
        <div class="card custom-card">
            <div class="card-header">
                <div class="card-title">Reset mật khẩu cho: <strong>@Model.TenDangNhap</strong></div>
            </div>
            <div class="card-body">
                <form asp-action="ResetPassword" method="post">
                    <input type="hidden" asp-for="UserId" />
                    <input type="hidden" asp-for="TenDangNhap" />

                    <div class="alert alert-info" role="alert">
                        <i class="ri-information-line me-1"></i> Bạn đang thay đổi mật khẩu cho người dùng <strong>@Model.TenDangNhap</strong>
                    </div>

                    <div class="mb-3">
                        <label for="NewPassword" class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input asp-for="NewPassword" type="password" class="form-control" placeholder="Nhập mật khẩu mới" id="passwordInput">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                <i class="ri-eye-line" id="toggleIcon"></i>
                            </button>
                        </div>
                        <span asp-validation-for="NewPassword" class="text-danger"></span>
                        <div id="passwordStrength" class="mt-1"></div>
                    </div>

                    <div class="mb-3">
                        <label for="ConfirmPassword" class="form-label">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
                        <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Nhập lại mật khẩu mới">
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="generatePassword()">
                            <i class="ri-refresh-line me-1"></i> Tạo mật khẩu ngẫu nhiên
                        </button>
                    </div>

                    <hr>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-wave">
                            <i class="ri-lock-password-line me-1"></i> Đặt lại mật khẩu
                        </button>
                        <a asp-action="Index" class="btn btn-light btn-wave">
                            <i class="ri-arrow-left-line me-1"></i> Quay lại
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card custom-card bg-warning-transparent">
            <div class="card-body">
                <h6 class="fw-semibold mb-2">
                    <i class="ri-shield-check-line me-1"></i> Yêu cầu mật khẩu mạnh
                </h6>
                <ul class="mb-0">
                    <li>Tối thiểu 8 ký tự</li>
                    <li>Có ít nhất một chữ thường (a-z)</li>
                    <li>Có ít nhất một chữ hoa (A-Z)</li>
                    <li>Có ít nhất một số (0-9)</li>
                    <li>Nên có ký tự đặc biệt (!@@#$%...)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Toggle password visibility
        function togglePassword() {
            const input = document.getElementById('passwordInput');
            const icon = document.getElementById('toggleIcon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'ri-eye-off-line';
            } else {
                input.type = 'password';
                icon.className = 'ri-eye-line';
            }
        }

        // Generate random password
        function generatePassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@@#$%^&*';
            let password = '';

            // Ensure at least one of each type
            password += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)];
            password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)];
            password += '0123456789'[Math.floor(Math.random() * 10)];
            password += '!@@#$%^&*'[Math.floor(Math.random() * 8)];

            // Fill the rest
            for (let i = 4; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }

            // Shuffle
            password = password.split('').sort(() => Math.random() - 0.5).join('');

            document.querySelector('[name="NewPassword"]').value = password;
            document.querySelector('[name="ConfirmPassword"]').value = password;

            // Show password
            document.getElementById('passwordInput').type = 'text';
            document.getElementById('toggleIcon').className = 'ri-eye-off-line';

            // Trigger strength check
            document.querySelector('[name="NewPassword"]').dispatchEvent(new Event('input'));

            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show mt-2';
            alert.innerHTML = `
                <i class="ri-check-line me-1"></i> Mật khẩu đã được tạo: <strong>${password}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('form').insertBefore(alert, document.querySelector('form').firstChild);

            setTimeout(() => alert.remove(), 5000);
        }

        // Password strength indicator
        document.querySelector('[name="NewPassword"]').addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            const indicator = document.getElementById('passwordStrength');

            if (password.length === 0) {
                indicator.innerHTML = '';
                return;
            }

            if (password.length >= 8) strength++;
            if (password.match(/[a-z]+/)) strength++;
            if (password.match(/[A-Z]+/)) strength++;
            if (password.match(/[0-9]+/)) strength++;
            if (password.match(/[^a-zA-Z0-9]+/)) strength++;

            const colors = ['danger', 'warning', 'info', 'success', 'success'];
            const labels = ['Rất yếu', 'Yếu', 'Trung bình', 'Mạnh', 'Rất mạnh'];
            const widths = [20, 40, 60, 80, 100];

            indicator.innerHTML = `
                <small class="text-${colors[strength - 1]}">Độ mạnh: ${labels[strength - 1]}</small>
                <div class="progress mt-1" style="height: 5px;">
                    <div class="progress-bar bg-${colors[strength - 1]}" role="progressbar" style="width: ${widths[strength - 1]}%"></div>
                </div>
            `;
        });
    </script>
}
